const requestControllers=new Map;function getGreeting(){const e=(new Date).getHours();return e>=5&&e<12?"Good morning \u{1f970}":e>=12&&e<18?"Good afternoon \u{1f970}":"Good evening \u{1f970}"}chrome.runtime.onMessage.addListener(((e,t,o)=>{if("getSettings"===e.action)return chrome.storage.sync.get(["deepseekApiKey","volcengineApiKey","siliconflowApiKey","openrouterApiKey","tencentcloudApiKey","iflytekstarApiKey","baiducloudApiKey","aliyunApiKey","language","model","provider","v3model","r1model"],(e=>{o({deepseekApiKey:e.deepseekApiKey||"",volcengineApiKey:e.volcengineApiKey||"",siliconflowApiKey:e.siliconflowApiKey||"",openrouterApiKey:e.openrouterApiKey||"",tencentcloudApiKey:e.tencentcloudApiKey||"",iflytekstarApiKey:e.iflytekstarApiKey||"",baiducloudApiKey:e.baiducloudApiKey||"",aliyunApiKey:e.aliyunApiKey||"",language:e.language||"en",model:e.model||"deepseek-chat",provider:e.provider||"deepseek",v3model:e.v3model||"",r1model:e.r1model||""})})),!0;if("proxyRequest"===e.action){const s=new AbortController,n=s.signal;return t?.tab?.id&&requestControllers.set(t.tab.id,s),e.body&&!e.body.includes('"model"')&&chrome.storage.sync.get(["model"],(t=>{const o=t.model||"deepseek-chat",s=JSON.parse(e.body);s.model=o,e.body=JSON.stringify(s)})),fetch(e.url,{method:e.method,headers:e.headers,body:e.body,signal:n}).then((async s=>{if(!e.body.includes('"stream":true'))return void o({status:s.status,ok:s.ok});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=s.body.getReader(),r=new TextDecoder;try{for(;;){const{done:e,value:o}=await n.read();if(e){t?.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{type:"streamResponse",response:{data:"data: [DONE]\n\n",ok:!0,done:!0}});break}const s=r.decode(o).split("\n");for(const e of s){if(""===e.trim())continue;if(!e.startsWith("data: "))continue;if("[DONE]"===e.slice(6)){t?.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{type:"streamResponse",response:{data:"data: [DONE]\n\n",ok:!0,done:!0}});break}t?.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{type:"streamResponse",response:{data:e+"\n\n",ok:!0,done:!1}})}}}catch(e){t?.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{type:"streamResponse",response:{ok:!1,error:e.message}})}finally{n.releaseLock()}})).catch((e=>{o({ok:!1,error:e.message})})).finally((()=>{t?.tab?.id&&requestControllers.delete(t.tab.id)})),!0}if("abortRequest"===e.action){const e=requestControllers.get(t.tab.id);return e&&(e.abort(),requestControllers.delete(t.tab.id)),o({success:!0}),!0}return"openPopup"===e.action?(chrome.action.openPopup(),!0):void 0})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"createPopup",title:"DeepSeek AI",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(((e,t)=>{"createPopup"===e.menuItemId&&chrome.tabs.sendMessage(t.id,{action:"createPopup",selectedText:e.selectionText||null,message:e.selectionText||getGreeting()})})),chrome.commands.onCommand.addListener((async e=>{if("toggle-chat"===e){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||e.url.startsWith("chrome://")||e.url.startsWith("edge://"))return;try{const[{result:t}]=await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>window.getSelection().toString()});chrome.tabs.sendMessage(e.id,{action:"toggleChat",selectedText:t||null,message:t||getGreeting()})}catch(t){chrome.tabs.sendMessage(e.id,{action:"toggleChat",selectedText:null,message:getGreeting()})}}else if("close-chat"===e){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||e.url.startsWith("chrome://")||e.url.startsWith("edge://"))return;chrome.tabs.sendMessage(e.id,{action:"closeChat"})}})),chrome.runtime.onInstalled.addListener((e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL&&chrome.tabs.create({url:chrome.runtime.getURL("Instructions/Instructions.html")})}));