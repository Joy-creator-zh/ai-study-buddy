import{ApiKeyManager}from"./apiKeyManager.js";import{BalanceManager}from"./balanceManager.js";import{I18nManager}from"./i18n.js";import{UiManager}from"./uiManager.js";import{StorageManager}from"./storageManager.js";class PopupManager{constructor(){this.apiKeyManager=new ApiKeyManager,this.balanceManager=new BalanceManager,this.i18nManager=new I18nManager,this.uiManager=new UiManager,this.storageManager=new StorageManager,this.initializeEventListeners(),this.loadInitialState()}async loadInitialState(){const e=await this.storageManager.getSettings(),a=e.provider||"deepseek",t=await this.apiKeyManager.getApiKey(a);t&&(this.uiManager.setApiKeyValue(t),this.apiKeyManager.lastValidatedValue=t,"deepseek"===a&&this.handleBalanceRefresh()),this.uiManager.elements.languageSelect.value=e.language,this.uiManager.elements.providerSelect.value=a,this.uiManager.elements.selectionEnabled.checked=e.selectionEnabled,this.uiManager.elements.rememberWindowSize.checked=e.rememberWindowSize,this.uiManager.elements.pinWindow.checked=e.pinWindow,e.v3model&&(this.uiManager.elements.v3modelInput.value=e.v3model),e.r1model&&(this.uiManager.elements.r1modelInput.value=e.r1model),this.updateProviderUI(a),e.model&&(this.uiManager.elements.modelSelect.value=e.model)}initializeEventListeners(){this.uiManager.elements.toggleButton.addEventListener("click",(()=>this.uiManager.toggleApiKeyVisibility())),this.uiManager.elements.apiKeyInput.addEventListener("blur",(()=>this.handleApiKeyValidation())),this.uiManager.elements.providerSelect.addEventListener("change",(async e=>{const a=e.target.value;await this.storageManager.saveProvider(a),this.updateProviderUI(a);const t=await this.apiKeyManager.getApiKey(a);this.uiManager.setApiKeyValue(t||""),this.apiKeyManager.lastValidatedValue=t||""})),this.uiManager.elements.languageSelect.addEventListener("change",(e=>this.storageManager.saveLanguage(e.target.value))),this.uiManager.elements.modelSelect.addEventListener("change",(e=>this.storageManager.saveModel(e.target.value))),this.uiManager.elements.v3modelInput.addEventListener("change",(e=>this.storageManager.saveV3Model(e.target.value))),this.uiManager.elements.r1modelInput.addEventListener("change",(e=>this.storageManager.saveR1Model(e.target.value))),this.uiManager.elements.selectionEnabled.addEventListener("change",(e=>this.storageManager.saveSelectionEnabled(e.target.checked))),this.uiManager.elements.rememberWindowSize.addEventListener("change",(e=>this.storageManager.saveRememberWindowSize(e.target.checked))),this.uiManager.elements.pinWindow.addEventListener("change",(e=>this.storageManager.savePinWindow(e.target.checked))),this.uiManager.elements.balanceToggle.addEventListener("click",(()=>this.handleBalanceToggle())),this.uiManager.elements.totalBalance.addEventListener("click",(()=>this.handleBalanceToggle())),document.getElementById("shortcutSettings").addEventListener("click",(e=>this.handleShortcutSettings(e))),document.getElementById("instructionsLink").addEventListener("click",(e=>this.handleInstructionsLink(e))),document.getElementById("collapseButton").addEventListener("click",(()=>{const e=document.getElementById("collapseButton"),a=document.getElementById("volcengineModelsContent");e.classList.toggle("collapsed"),a.classList.toggle("collapsed")}))}updateProviderUI(e){document.querySelector(".volcengine-models").style.display="volcengine"===e?"block":"none";document.querySelector(".balance-section").style.display="deepseek"===e?"flex":"none";const a={deepseek:"https://platform.deepseek.com/api_keys",volcengine:"https://console.volcengine.com/ark/region:ark+cn-beijing/apiKey?apikey=%7B%7D",siliconflow:"https://cloud.siliconflow.cn/i/lStn36vH",openrouter:"https://openrouter.ai/settings/keys",tencentcloud:"https://console.cloud.tencent.com/lkeap/api",iflytekstar:"https://training.xfyun.cn/modelService",baiducloud:"https://console.bce.baidu.com/iam/#/iam/apikey/create",aliyun:"https://bailian.console.aliyun.com/?apiKey=1#/api-key"};document.getElementById("apiKeyLink").href=a[e]||a.deepseek,this.updateModelOptions(e)}updateModelOptions(e){const a=this.uiManager.elements.modelSelect;a.value;a.innerHTML="";const t={deepseek:[{value:"deepseek-chat",label:"DeepSeek-V3"},{value:"deepseek-reasoner",label:"DeepSeek-R1"}],siliconflow:[{value:"deepseek-ai/DeepSeek-V3",label:"DeepSeek-V3"},{value:"deepseek-ai/DeepSeek-R1",label:"DeepSeek-R1"},{value:"Pro/deepseek-ai/DeepSeek-V3",label:"Pro DeepSeek-V3"},{value:"Pro/deepseek-ai/DeepSeek-R1",label:"Pro DeepSeek-R1"}],volcengine:[{value:"v3",label:"DeepSeek-V3"},{value:"r1",label:"DeepSeek-R1"}],openrouter:[{value:"deepseek/deepseek-chat:free",label:"DeepSeek-V3 Free"},{value:"deepseek/deepseek-r1:free",label:"DeepSeek-R1 Free"},{value:"deepseek/deepseek-chat",label:"DeepSeek-V3"},{value:"deepseek/deepseek-r1",label:"DeepSeek-R1"}],tencentcloud:[{value:"deepseek-v3",label:"DeepSeek-V3"},{value:"deepseek-r1",label:"DeepSeek-R1"}],iflytekstar:[{value:"xdeepseekv3",label:"DeepSeek-V3"},{value:"xdeepseekr1",label:"DeepSeek-R1"}],baiducloud:[{value:"deepseek-v3",label:"DeepSeek-V3"},{value:"deepseek-r1",label:"DeepSeek-R1"}],aliyun:[{value:"deepseek-v3",label:"DeepSeek-V3"},{value:"deepseek-r1",label:"DeepSeek-R1"}]}[e]||[];t.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,a.appendChild(t)})),this.storageManager.getSettings().then((e=>{e.model&&t.some((a=>a.value===e.model))?a.value=e.model:(a.value=t[0]?.value||"",this.storageManager.saveModel(a.value))}))}async handleApiKeyValidation(){const e=this.uiManager.getApiKeyValue(),a=this.uiManager.elements.providerSelect.value;if(e){if("volcengine"===a){const e=this.uiManager.elements.v3modelInput.value,a=this.uiManager.elements.r1modelInput.value;if(!e&&!a)return void this.uiManager.showMessage(this.i18nManager.getTranslation("modelIdRequired"),!1)}this.uiManager.showMessage(this.i18nManager.getTranslation("validating"),!0);try{const t={model:this.uiManager.elements.modelSelect.value,v3model:this.uiManager.elements.v3modelInput.value,r1model:this.uiManager.elements.r1modelInput.value};await this.apiKeyManager.validateApiKey(e,a,t)?(this.uiManager.showMessage(this.i18nManager.getTranslation("saveSuccess"),!0),"deepseek"===a&&this.handleBalanceRefresh()):this.uiManager.showMessage(this.i18nManager.getTranslation("apiKeyInvalid"),!1)}catch(e){console.error("API validation error:",e),this.uiManager.showMessage(this.i18nManager.getTranslation("fetchError"),!1)}}else this.uiManager.showMessage(this.i18nManager.getTranslation("apiKeyEmpty"),!1)}async handleBalanceRefresh(){if(this.balanceManager.isLoading())return;const e=await this.apiKeyManager.getApiKey("deepseek");if(e){this.balanceManager.setLoading(!0),this.uiManager.showLoadingState();try{const a=await this.balanceManager.fetchBalance(e);this.uiManager.updateBalanceDisplay(a,this.i18nManager.getTranslation("noBalance"))}catch(e){this.uiManager.elements.totalBalance.textContent=this.i18nManager.getTranslation("fetchError")}finally{this.balanceManager.setLoading(!1)}}else this.uiManager.elements.totalBalance.textContent=this.i18nManager.getTranslation("noApiKey")}handleBalanceToggle(){this.uiManager.toggleBalance()&&"--"===this.uiManager.elements.totalBalance.textContent&&this.handleBalanceRefresh()}handleShortcutSettings(e){e.preventDefault(),chrome.tabs.create({url:"chrome://extensions/shortcuts"})}handleInstructionsLink(e){e.preventDefault();const a=chrome.runtime.getURL("Instructions/Instructions.html");chrome.tabs.create({url:a})}async validateAndSaveApiKey(e,a){if(e)try{await this.apiKeyManager.validateApiKey(e,a)?(this.uiManager.showMessage(this.i18nManager.getTranslation("saveSuccess"),!0),await this.loadApiKey(a)):this.uiManager.showMessage(this.i18nManager.getTranslation("apiKeyInvalid"),!1)}catch(e){console.error("Validation error:",e),this.uiManager.showMessage(this.i18nManager.getTranslation("fetchError"),!1)}else this.uiManager.showMessage(this.i18nManager.getTranslation("apiKeyEmpty"),!1)}}document.addEventListener("DOMContentLoaded",(()=>{new PopupManager,updateContent()}));const translations={zh:{headerTitle:"DeepSeek AI",apiKeyPlaceholder:"\u5728\u6b64\u8f93\u5165 API Key",apiKeyLink:"\u524d\u5f80\u83b7\u53d6 API Key",preferredLanguageLabel:"\u9996\u9009\u8bed\u8a00",providerLabel:"\u670d\u52a1\u63d0\u4f9b\u5546",modelLabel:"\u6a21\u578b\u9009\u62e9",saveButton:"\u4fdd\u5b58",shortcutSettingsText:"\u5feb\u6377\u952e\u8bbe\u7f6e",shortcutDescription:"\u8bf7\u524d\u5f80\u8bbe\u7f6e\u5feb\u6377\u952e",instructionsText:"\u4f7f\u7528\u8bf4\u660e",feedbackText:"\u53cd\u9988",statusText:"API \u670d\u52a1\u72b6\u6001",balanceText:"\u4f59\u989d",noBalance:"\u65e0\u53ef\u7528\u4f59\u989d",noApiKey:"\u8bf7\u5148\u8bbe\u7f6eAPI Key",fetchError:"\u67e5\u8be2\u5931\u8d25",apiKeyEmpty:"\u8bf7\u8f93\u5165 API Key",apiKeyInvalid:"API Key \u65e0\u6548",saveSuccess:"\u8bbe\u7f6e\u5df2\u4fdd\u5b58",selectionEnabledLabel:"\u5feb\u6377\u6309\u94ae",selectionEnabledTip:"\u9009\u4e2d\u6587\u672c\u540e\u663e\u793a\u5feb\u6377\u6309\u94ae\uff0c\u70b9\u51fb\u53ef\u5feb\u901f\u6253\u5f00\u4f1a\u8bdd\u7a97\u53e3",validating:"\u6b63\u5728\u9a8c\u8bc1...",rememberWindowSizeLabel:"\u4fdd\u5b58\u7a97\u53e3\u5927\u5c0f",rememberWindowSizeTip:"\u8bb0\u4f4f\u60a8\u8c03\u6574\u540e\u7684\u4f1a\u8bdd\u7a97\u53e3\u5927\u5c0f\uff0c\u4e0b\u6b21\u6253\u5f00\u65f6\u5c06\u4fdd\u6301\u76f8\u540c\u5c3a\u5bf8",pinWindowLabel:"\u56fa\u5b9a\u7a97\u53e3",pinWindowTip:"\u5f00\u542f\u540e\uff0c\u70b9\u51fb\u7a97\u53e3\u5916\u90e8\u4e0d\u4f1a\u81ea\u52a8\u5173\u95ed\u4f1a\u8bdd\u7a97\u53e3",warningMessage:"\u90e8\u5206\u670d\u52a1\u5546API\u5982\u82e5\u4e0d\u80fd\u6b63\u5e38\u4f7f\u7528\u8bf7\u5207\u6362\u670d\u52a1\u5546",getModelId:"\u83b7\u53d6\u6a21\u578bID\uff08\u5fc5\u586b\uff09",v3ModelLabel:"V3 Model ID:",r1ModelLabel:"R1 Model ID:",volcengineModelsTitle:"\u706b\u5c71\u5f15\u64ce\u6a21\u578b\u914d\u7f6e",volcengineProvider:"\u706b\u5c71\u5f15\u64ce",siliconflowProvider:"\u7845\u57fa\u6d41\u52a8",tencentcloudProvider:"\u817e\u8baf\u4e91",iflytekstarProvider:"\u8baf\u98de\u661f\u8fb0",baiducloudProvider:"\u767e\u5ea6\u667a\u80fd\u4e91",aliyunProvider:"\u963f\u91cc\u4e91"},en:{headerTitle:"DeepSeek AI",apiKeyPlaceholder:"Enter API Key here",apiKeyLink:"Get API Key",preferredLanguageLabel:"Preferred Language",providerLabel:"Service Provider",modelLabel:"Model Selection",saveButton:"Save",shortcutSettingsText:"Shortcut Settings",shortcutDescription:"Please configure shortcut keys",instructionsText:"Instructions",feedbackText:"Feedback",statusText:"API Service Status",balanceText:"Balance",noBalance:"No available balance",noApiKey:"Please set API Key first",fetchError:"Failed to fetch",apiKeyEmpty:"Please enter API Key",apiKeyInvalid:"Invalid API Key",saveSuccess:"Settings saved",selectionEnabledLabel:"Quick Button",selectionEnabledTip:"Show a quick button when text is selected to open the chat window",validating:"Validating...",rememberWindowSizeLabel:"Save Window Size",rememberWindowSizeTip:"Remember your preferred chat window size for future sessions",pinWindowLabel:"Pin Window",pinWindowTip:"When enabled, clicking outside the window won't close it",warningMessage:"If some service provider APIs cannot be used normally, please switch providers.",getModelId:"Get Model ID(required)",v3ModelLabel:"V3 Model ID:",r1ModelLabel:"R1 Model ID:",volcengineModelsTitle:"Volcengine Models Configuration",volcengineProvider:"Volcano Engine",siliconflowProvider:"SiliconFlow",tencentcloudProvider:"Tencent Cloud",iflytekstarProvider:"IFlytek Star",baiducloudProvider:"Baidu Cloud",aliyunProvider:"Aliyun"}},getCurrentLang=()=>localStorage.getItem("preferredLang")||"en",setCurrentLang=e=>localStorage.setItem("preferredLang",e),updateContent=()=>{const e=getCurrentLang(),a=translations[e],t=document.getElementById("warningText");t&&(t.textContent=a.warningMessage);const n={"header-title":a.headerTitle,apiKey:{placeholder:a.apiKeyPlaceholder},apiKeyLink:a.apiKeyLink,preferredLanguageLabel:a.preferredLanguageLabel,providerLabel:a.providerLabel,modelLabel:a.modelLabel,saveButton:a.saveButton,shortcutSettingsText:a.shortcutSettingsText,shortcutDescription:a.shortcutDescription,instructionsText:a.instructionsText,feedbackText:a.feedbackText,statusText:a.statusText,balanceText:a.balanceText,selectionEnabledLabel:a.selectionEnabledLabel,rememberWindowSizeLabel:a.rememberWindowSizeLabel,pinWindowLabel:a.pinWindowLabel,getModelId:a.getModelId,v3ModelLabel:a.v3ModelLabel,r1ModelLabel:a.r1ModelLabel,volcengineModelsTitle:a.volcengineModelsTitle,volcengineProvider:a.volcengineProvider,siliconflowProvider:a.siliconflowProvider,tencentcloudProvider:a.tencentcloudProvider,iflytekstarProvider:a.iflytekstarProvider,baiducloudProvider:a.baiducloudProvider,aliyunProvider:a.aliyunProvider};Object.entries(n).forEach((([e,a])=>{const t=document.getElementById(e);t&&("object"==typeof a?Object.entries(a).forEach((([e,a])=>{t[e]=a})):t.textContent=a)}));const i={selectionEnabledLabel:a.selectionEnabledTip,rememberWindowSizeLabel:a.rememberWindowSizeTip,pinWindowLabel:a.pinWindowTip};Object.entries(i).forEach((([e,a])=>{const t=document.getElementById(e);t&&t.setAttribute("data-tooltip",a)}));const l=document.getElementById("totalBalance");if(l){const e=l.textContent,t={\u65e0\u53ef\u7528\u4f59\u989d:a.noBalance,"\u8bf7\u5148\u8bbe\u7f6eAPI Key":a.noApiKey,\u67e5\u8be2\u5931\u8d25:a.fetchError};t[e]&&(l.textContent=t[e])}document.getElementById("language").value=e;const r=document.getElementById("volcengineProvider");r&&(r.textContent=a.volcengineProvider)};document.getElementById("language-toggle").addEventListener("click",(()=>{const e=getCurrentLang();setCurrentLang("zh"===e?"en":"zh"),updateContent()})),document.getElementById("language").addEventListener("change",(e=>{}));